
<script>
    (function(window) {
        const DGT_ELEMENTS_TEMPLATES = new Map();

        function getAttributeName(value) {
            return value.split(/(?=[A-Z])/).join('-').toLowerCase();
        }

        function setupProperties(instance, properties) {
            for (const prop of properties) {
                // console.log('setup prop', prop);
                const propMap = new WeakMap();
                const key = {name: prop.attribute};
                const attrName = getAttributeName(prop.attribute);

                if (prop.reflectToAttribute) {
                    const mutObserver = new MutationObserver(instance.mutationObserverCallback.bind(instance));
                    mutObserver.observe(instance, {attributes: true});
                }

                Object.defineProperty(instance, prop.attribute, {
                    get: function() {
                        return propMap.get(key);
                    },
                    set: function(newValue) {
                        const oldValue = propMap.get(key);
                        propMap.set(key, newValue);

                        if (prop.reflectToAttribute) {
                            if (newValue !== null && newValue !== undefined) {
                                this.setAttribute(attrName, newValue);
                            } else {
                                this.removeAttribute(attrName);
                            }
                        }
                        if (prop.observer) {
                            prop.observer(newValue, oldValue);
                        }

                        if (prop.global) {
                            let eventName = 'changed' + this.__capitalize(prop.attribute);
                            this.dispatchEvent(new CustomEvent(eventName, {
                                detail: {newValue, oldValue}
                            }));
                        }
                    }
                });
                const initialValue = prop.value === undefined ? null : prop.value;

                propMap.set(key, initialValue);
                if (prop.reflectToAttribute && initialValue) {
                    instance.setAttribute(attrName, initialValue);
                }
            }
        }

        class DGTElement extends HTMLElement {
            constructor() {
                super();
                this.template = DGT_ELEMENTS_TEMPLATES.get(this.tagName);
                const shady = this.attachShadow({mode: 'closed'});
                const instance = this.template.content.cloneNode(true);
                shady.appendChild(instance);
                if (this.constructor.properties) {
                    setupProperties(this, this.constructor.properties);
                }
            }

            __capitalize(str) {
                return str.charAt(0).toUpperCase() + str.slice(1);
            }

            mutationObserverCallback(mutations) {
                for (let mutation of mutations) {
                    let target = mutation.target;
                    let newValue = target.getAttribute(mutation.attributeName);
                    if (this.disabled !== newValue) {
                        this.disabled = newValue;
                    }
                }
            }

            fire(eventName, data){
                this.dispatchEvent(new CustomEvent(eventName, {
                    detail: data
                }));
            }
            listen(eventName, fn){
                this.addEventListener(eventName, fn);
            }
            static registerElement(componentId, componentClass) {
                let query = '[href*=' + componentId + '] template';
                if (!window.ShadyDOM) {
                    query = 'template';
                }
                DGT_ELEMENTS_TEMPLATES.set(componentId.toUpperCase(),
                    document.currentScript.ownerDocument.querySelector(query));
                customElements.define(componentId, componentClass);
            }

            static error() {
                /* eslint-disable no-console */
                console.error.apply(null, arguments);
                /* eslint-enable no-console */
            }
        }

        window.DGTElement = DGTElement;
    })(window);

</script>